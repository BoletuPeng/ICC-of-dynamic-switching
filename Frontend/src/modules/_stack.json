{
  "id": "stack",
  "name": "Stack",
  "description": "Collect loop outputs and stack them back into batch dimensions. Uses Loop Id Ref from For Loop to automatically restore the original shape structure.",
  "category": "control",
  "color": "#6366f1",
  "icon": "layers",
  "isControlFlow": true,
  "controlFlowType": "stack",

  "inputs": [
    {
      "id": "loop_output",
      "name": "Loop Output",
      "type": "ndarray",
      "dtype": "any",
      "shape": ["..."],
      "description": "Processed data from loop body. Shape will be validated against Loop Id Ref."
    },
    {
      "id": "loop_id_ref",
      "name": "Loop Id Ref",
      "type": "loop_ref",
      "dtype": "ref",
      "shape": [],
      "description": "Reference from For Loop carrying the stripped dimension information for shape reconstruction."
    }
  ],

  "outputs": [
    {
      "id": "data_out",
      "name": "Stacked Output",
      "type": "ndarray",
      "dtype": "any",
      "shape": ["..."],
      "description": "Stacked output with batch dimensions restored. Shape equals stripped dimensions + loop output shape."
    }
  ],

  "parameters": [
    {
      "id": "stack_order",
      "name": "Stack Order",
      "type": "select",
      "options": [
        { "value": "prepend", "label": "Prepend (batch, inner)" },
        { "value": "append", "label": "Append (inner, batch)" }
      ],
      "default": "prepend",
      "description": "Where to place the stacked batch dimensions relative to the loop output shape"
    }
  ]
}
